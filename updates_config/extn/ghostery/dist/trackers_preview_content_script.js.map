{"version":3,"file":"trackers_preview_content_script.js","mappings":"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","sources":["webpack://@ghostery/extension-manifest-v2/../node_modules/@ghostery/ui/src/utils/categories.js","webpack://@ghostery/extension-manifest-v2/../node_modules/@ghostery/ui/src/utils/wheel.js","webpack://@ghostery/extension-manifest-v2/../node_modules/@whotracksme/webextension-packages/packages/trackers-preview/src/content_scripts/index.js","webpack://@ghostery/extension-manifest-v2/./app/content-scripts/trackers-preview.js"],"sourcesContent":["/**\n * Ghostery Browser Extension\n * https://www.ghostery.com/\n *\n * Copyright 2017-present Ghostery GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0\n */\nconst colors = {\n  advertising: ' #CB55CD',\n  site_analytics: '#87D7EF',\n  consent: '#556FCD',\n  essential: '#FC9734',\n  hosting: '#8459A5',\n  customer_interaction: '#EF671E',\n  unidentified: '#E8E8E8',\n  audio_video_player: '#4ECB4E',\n  cdn: '#4ECBA1',\n  comments: '#4EA1CB',\n  email: '#4E4ECB',\n  extensions: '#A14ECB',\n  misc: '#CB4EA1',\n  pornvertising: '#CB4E4E',\n  social_media: '#CBA14E',\n  telemetry: '#A1CB4E'\n};\nexport const order = ['advertising', 'site_analytics', 'consent', 'essential', 'hosting', 'customer_interaction', 'audio_video_player', 'cdn', 'comments', 'email', 'extensions', 'misc', 'pornvertising', 'social_media', 'telemetry', 'unidentified'];\nexport const getCategoryKey = category => {\n  return colors[category] ? category : 'unidentified';\n};\nexport const getCategoryColor = category => {\n  return colors[getCategoryKey(category)];\n};\nexport const sortCategories = (resolveCategoryName = a => a) => {\n  return (a, b) => {\n    const a1 = getCategoryKey(resolveCategoryName(a));\n    const b1 = getCategoryKey(resolveCategoryName(b));\n    return order.indexOf(a1) - order.indexOf(b1);\n  };\n};","/**\n * Ghostery Browser Extension\n * https://www.ghostery.com/\n *\n * Copyright 2017-present Ghostery GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0\n */\nimport { getCategoryColor, order, getCategoryKey } from './categories.js';\n\nfunction degToRad(degree) {\n  const factor = Math.PI / 180;\n  return degree * factor;\n}\n\nexport function drawWheel(ctx, size, categories, useScale = true) {\n  if (useScale && typeof window !== 'undefined') {\n    const {\n      canvas\n    } = ctx;\n    canvas.style.width = size + 'px';\n    canvas.style.height = size + 'px'; // Set actual size in memory (scaled to account for extra pixel density).\n\n    const scale = window.devicePixelRatio;\n    canvas.width = Math.floor(size * scale);\n    canvas.height = Math.floor(size * scale); // Normalize coordinate system to use css pixels.\n\n    ctx.scale(scale, scale);\n  } // Group trackers by sorted category\n  // (JavaScript objects will preserve the order)\n\n\n  const groupedCategories = {};\n  order.forEach(c => groupedCategories[getCategoryKey(c)] = 0);\n  categories.forEach(c => groupedCategories[getCategoryKey(c)] += 1);\n  const center = size / 2;\n  const increment = 360 / categories.length;\n  /* Background START */\n  // This special blue background is required for Desktop Safari to render the colors property\n  // We've tried: white, black, red and transparent - non of those works\n  // Line width has to be a little bit smaller than the final arc so it blue wont be visible on dithered edges.\n  // Line width cannot be too small as otherwise Safari will render the colors incorrectly.\n  // Number below were chosen by trial end error.\n\n  ctx.lineWidth = Math.floor(size * 0.14) * 0.95;\n  const radius = size / 2 - ctx.lineWidth;\n  ctx.strokeStyle = 'blue';\n  ctx.beginPath();\n  ctx.arc(center, center, Math.floor(radius), 0, 2 * Math.PI);\n  ctx.stroke();\n  /* Background END */\n\n  ctx.lineWidth = size * 0.14;\n  let position = -90;\n\n  for (const [category, numTrackers] of Object.entries(groupedCategories)) {\n    if (numTrackers > 0) {\n      const newPosition = position + numTrackers * increment;\n      const color = getCategoryColor(category);\n      ctx.strokeStyle = color;\n      ctx.beginPath();\n      ctx.arc(center, center, radius, degToRad(position), Math.min(degToRad(newPosition + 1), 2 * Math.PI));\n      ctx.stroke();\n      position = newPosition;\n    }\n  }\n}\nexport function getOffscreenImageData(size, categories) {\n  let canvas;\n\n  try {\n    canvas = new OffscreenCanvas(size, size);\n  } catch (e) {\n    canvas = document.createElement('canvas');\n    canvas.width = size;\n    canvas.height = size;\n  }\n\n  const ctx = canvas.getContext('2d');\n  drawWheel(ctx, size, categories, false);\n  return ctx.getImageData(0, 0, size, size);\n}","/**\n * WhoTracks.Me\n * https://whotracks.me/\n *\n * Copyright 2017-present Ghostery GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0\n */\nimport { drawWheel } from '@ghostery/ui/wheel';\n\nconst WRAPPER_CLASS = 'wtm-popup-iframe-wrapper';\n\nconst isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);\n\nfunction closePopups() {\n  [...document.querySelectorAll(`.${WRAPPER_CLASS}`)].forEach((popup) => {\n    popup.parentElement.removeChild(popup);\n  });\n}\n\nfunction resizePopup(height) {\n  [...document.querySelectorAll(`.${WRAPPER_CLASS}`)].forEach((popup) => {\n    popup.style.height = `${height}px`;\n  });\n}\n\nconst getTop = (el) =>\n  el.offsetTop + (el.offsetParent && getTop(el.offsetParent));\n\nfunction renderPopup(container, stats, popupUrl) {\n  closePopups();\n\n  const wrapper = document.createElement('div');\n  wrapper.classList.add(WRAPPER_CLASS);\n  if (isMobile) {\n    wrapper.style.width = window.innerWidth - 20 + 'px';\n    wrapper.style.left = '10px';\n  } else {\n    const left = container.getBoundingClientRect().left - 350 / 2 + 12;\n    wrapper.style.left = (left < 20 ? 20 : left) + 'px';\n  }\n  wrapper.style.top = getTop(container) + 25 + 'px';\n\n  const iframe = document.createElement('iframe');\n  iframe.setAttribute('src', `${popupUrl}?domain=${stats.domain}`);\n\n  wrapper.appendChild(iframe);\n  document.body.appendChild(wrapper);\n}\n\nfunction getWheelElement(stats, popupUrl) {\n  const count = stats.stats.length;\n\n  if (count === 0) {\n    return null;\n  }\n\n  const container = document.createElement('div');\n  container.classList.add('wtm-tracker-wheel-container');\n\n  const label = document.createElement('label');\n  label.innerText = count;\n\n  const canvas = document.createElement('canvas');\n  canvas.classList.add('wtm-tracker-wheel');\n\n  const ctx = canvas.getContext('2d');\n  drawWheel(ctx, 16, stats.stats);\n\n  container.appendChild(canvas);\n  container.appendChild(label);\n\n  container.addEventListener('click', (ev) => {\n    ev.preventDefault();\n    ev.stopImmediatePropagation();\n\n    renderPopup(container, stats, popupUrl);\n  });\n\n  return container;\n}\n\nfunction removeWheel(anchor) {\n  const container = anchor.parentElement.querySelector(\n    '.wtm-tracker-wheel-container',\n  );\n  if (container) {\n    container.parentElement.removeChild(container);\n  }\n}\n\nexport default function setupTrackersPreview(popupUrl) {\n  const elements = [\n    ...window.document.querySelectorAll(\n      '[data-hveid] div.yuRUbf > a, [data-hveid] div.xpd a.cz3goc, [data-hveid] > .xpd > div.kCrYT:first-child > a',\n    ),\n  ];\n\n  if (elements.length) {\n    const links = elements.map((el) => {\n      if (el.hostname === window.location.hostname) {\n        const url = new URL(el.href);\n        return url.searchParams.get('url') || url.searchParams.get('q');\n      }\n      return el.href;\n    });\n\n    chrome.runtime.sendMessage(\n      { action: 'getWTMReport', links },\n      (response) => {\n        if (chrome.runtime.lastError) {\n          console.error(\n            'Could not retrieve WTM information on URLs',\n            chrome.runtime.lastError,\n          );\n          return;\n        }\n\n        document.addEventListener('click', (event) => {\n          let el = event.target;\n          while (el && !el.href) el = el.parentElement;\n\n          if (!el) return;\n\n          closePopups();\n        });\n\n        elements.forEach((anchor, i) => {\n          const stats = response.wtmStats[i];\n          if (stats) {\n            try {\n              const wheelEl = getWheelElement(stats, popupUrl);\n              if (!wheelEl) return;\n\n              const parent = anchor.parentElement;\n\n              const container =\n                // Desktop flat\n                parent.querySelector('.B6fmyf') ||\n                // Mobile flat\n                anchor.querySelector('div[role=\"link\"]') ||\n                // Mobile cards\n                anchor.querySelector('div.UPmit.AP7Wnd');\n              if (!container) return;\n\n              let tempEl = container.firstElementChild;\n              if (tempEl && tempEl.textContent.includes(stats.domain)) {\n                container.insertBefore(wheelEl, tempEl.nextElementSibling);\n              } else {\n                container.appendChild(wheelEl);\n              }\n            } catch (e) {\n              console.warn(\n                'Unexpected error while rendering the Tracker Preview wheel',\n                e,\n              );\n            }\n          }\n        });\n      },\n    );\n\n    window.addEventListener('message', (message) => {\n      if (\n        message.origin + '/' !== chrome.runtime.getURL('/').toLowerCase() &&\n        typeof message.data == 'string'\n      ) {\n        return;\n      }\n\n      if (message.data === 'WTMReportClosePopups') {\n        closePopups();\n      } else if (message.data === 'WTMReportDisable') {\n        closePopups();\n        elements.forEach(removeWheel);\n        chrome.runtime.sendMessage({ action: 'disableWTMReport' });\n      } else if (message.data.startsWith('WTMReportResize')) {\n        const height = message.data.split(':')[1];\n        resizePopup(height);\n      }\n    });\n  }\n}\n","import setupTrackersPreview from '@whotracksme/webextension-packages/packages/trackers-preview/src/content_scripts';\n\nsetupTrackersPreview(\n\tchrome.runtime.getURL('/app/templates/trackers-preview.html'),\n);\n"],"names":["colors","order","getCategoryKey","category","getCategoryColor","sortCategories","resolveCategoryName","a","b","a1","b1","degToRad","degree","factor","drawWheel","ctx","size","categories","useScale","canvas","scale","groupedCategories","c","center","increment","radius","position","numTrackers","newPosition","color","getOffscreenImageData","WRAPPER_CLASS","isMobile","closePopups","popup","resizePopup","height","getTop","el","renderPopup","container","stats","popupUrl","wrapper","left","iframe","getWheelElement","count","label","ev","removeWheel","anchor","setupTrackersPreview","elements","links","url","response","event","i","wheelEl","tempEl","e","message"],"sourceRoot":""}